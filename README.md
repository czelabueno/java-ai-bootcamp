# Java + AI: Deep Dive Bootcamp
Repository that seeks to inspire Java developers in the development of AI-based applications

## Agenda:

### Part 1:

#### Chat

```java
    @GetMapping("/response")
    public ChatResponse response(@RequestParam(defaultValue = "I'm planning a trip to South America. Can you suggest best 10 Java User groups to visit?") String message ) {
        return chatClient.prompt()
                .user(message)
                .call()
                .chatResponse();
    }
```
#### Prompting
#### Memory
```java
    public MemoryController(ChatClient.Builder builder) {
    this.chatClient = builder
            .defaultAdvisors(new MessageChatMemoryAdvisor(new InMemoryChatMemory()))
            .build();
}
```
#### Structured Output
```java
    @GetMapping("/output/structured")
    public Itinerary structured() {
        return chatClient.prompt()
                .user("What is the good plan to visit Lima for 5 days?")
                .call()
                .entity(Itinerary.class);
    }

    record Activity(String activity, String location, String day, String time) {}
    record Itinerary(List<Activity> activities) {}
```
#### Tokenization

```java
   @GetMapping("/tokenization/usage")
    public Usage tokenization(@RequestParam(defaultValue = "Tell me a fun fact about Java") String message) {
        return chatClient.prompt()
                .user(message)
                .call()
                .chatResponse()
                .getMetadata()
                .getUsage();
    }
```
```java
    @GetMapping("/tokenization/my-response")
    public MyResponse tokenizationResponse(@RequestParam(defaultValue = "Tell me a fun fact about Java") String message) {
        return chatClient.prompt()
                .user(message)
                .call()
                .entity(MyResponse.class);
    }

record MyResponse(String prompt, String completion, Usage usage) {
    record Usage(int promptTokens, int completionTokens, int totalTokens) {
    }
}
```
#### Tools
- Function Calling
```java
    @GetMapping("/date/tool")
    public String daterTool() {
        return chatClient.prompt("What day is tomorrow?")
                .tools(new DateTools())
                .call()
                .content();
    }
```
```java
public class DateTools {

    @Tool(description = "Get the current date and time of the user time zone")
    String getCurrentDateTime() {
        return LocalDateTime.now().atZone(LocaleContextHolder.getTimeZone().toZoneId()).toString();
    }
}
```
#### Vector Store
##### PGVector
- Running with Docker

```shell
docker run --name pgvector-demo -e POSTGRES_PASSWORD=test -p 5432:5432 pgvector/pgvector:pg17
```
- PSQL Query
```sql
-- Schema creation
CREATE EXTENSION IF NOT EXISTS vector;
CREATE EXTENSION IF NOT EXISTS hstore;
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

CREATE TABLE IF NOT EXISTS vector_store (
	id uuid DEFAULT uuid_generate_v4() PRIMARY KEY,
	content text,
	metadata json,
	embedding vector(1536)
);

CREATE INDEX ON vector_store USING HNSW (embedding vector_cosine_ops);

-- Query
SELECT * FROM public.vector_store
```
- Spring properties

```xml
 <dependency>
  <groupId>org.springframework.ai</groupId>
  <artifactId>spring-ai-pgvector-store-spring-boot-starter</artifactId>
</dependency>
```
```properties
spring.datasource.url= jdbc:postgresql://localhost:5432/postgres
spring.datasource.username= postgres
spring.datasource.password= test
spring.ai.vectorstore.pgvector.index-type= HNSW
spring.ai.vectorstore.pgvector.distance-type= COSINE_DISTANCE
spring.ai.vectorstore.pgvector.dimensions= 1536
```

```java
    private final VectorStore vectorStore;

    public VectorStoreController(VectorStore vectorStore, EmbeddingModel embeddingModel) {
        this.vectorStore = vectorStore;
        List<Document> documents = List.of(
                new Document("Java AI rocks!! Java AI rocks!! Java AI rocks!! Java AI rocks!! Java AI rocks!!", Map.of("meta1", "meta1")),
                new Document("The World is Big and Salvation Lurks Around the Corner"),
                new Document("You walk forward facing the past and you turn back toward the future.", Map.of("meta2", "meta2")));

        // Add the documents to PGVector
        vectorStore.add(documents);
    }

    @GetMapping("/vector-store")
    public List<Document> getVectorStore(@RequestParam(defaultValue = "Spring AI") String message) {
        return vectorStore.similaritySearch(
                SearchRequest.builder()
                        .query(message)
                        .topK(3) // similar number of docs
                        .build()
        );
    }
```
##### Embeddings
- Spring properties

```properties
spring.ai.openai.embedding.options.model=text-embedding-ada-002
```

```java
    private final EmbeddingModel embeddingModel;

    @GetMapping("/embedding")
    public Map embedMessage(@RequestParam(defaultValue = "Spring AI") String message) {
        EmbeddingResponse embeddingResponse = this.embeddingModel.embedForResponse(List.of(message));
        return Map.of("embedding", embeddingResponse);
    }
```
Link to convert in-line data: https://www.textfixer.com/tools/paragraph-to-lines.php
```sql
-- Cosine similarity Query
SELECT content, (embedding <=> '[ -0.011967382, -0.009636892, 0.0014066923, -0.0010366483, -0.00093429565, 0.025376448, -0.021289343, 0.01595651, -0.002131034, -0.033060767, 0.019399757, 0.008741088, 0.0018178524, 0.0044825193, 0.003172056, -0.0048709344, 0.019329771, -0.011897397, 0.014962727, -0.0032577873, -0.0006753523, 0.014430843, 0.001298216, -0.008356173, 0.0014862999, -0.017748117, 0.01014778, -0.039667323, -0.0027783923, -0.025810353, 0.038575564, -0.017076265, -0.012037367, -0.01513069, -0.0037371826, 0.014269879, -0.0014443091, 0.006907489, 0.017538164, -0.014710782, 0.019721687, 0.022003187, -0.0045245104, -0.019665698, -0.009986816, 0.0154666165, -0.018140033, -0.00021990502, -0.012779205, 0.013241104, 0.015018715, 0.03625207, -0.014654795, -0.0055987756, -0.0058717155, -0.0021415316, -0.022619052, 0.022801012, 0.029953448, -0.0031300653, 0.011316525, -0.011785422, -0.024326678, 0.028973663, -0.002720655, 0.0027678946, -0.0019945637, 0.019399757, 0.007565345, -0.0029621022, 0.015802544, 0.014570813, -0.0034729904, -0.013751992, 0.025138501, -0.0021922705, -0.004486019, 0.0022919986, -0.00026834756, 0.008006249, 0.0009841598, -0.0050668917, -0.0049724123, 0.013905958, 0.022745024, 0.0038876496, -0.011722436, 0.010616678, -0.0048429407, -0.005171869, 0.006190146, 0.0058367234, 0.014213891, 0.016810322, -0.027699942, 0.018210016, -0.0047204676, 0.013108132, -0.009342956, -0.038043678, -0.001334958, -0.0016026495, -0.018839879, -0.013255101, -0.0075163557, -0.0050458964, 0.007789296, 0.028721718, 0.010980599, 0.016110476, -0.006501578, 0.013723998, 0.022507077, -0.034992345, -0.016796326, -0.010063799, -7.665511e-05, -0.02039354, -0.034040555, -0.024102729, 0.03140913, 0.032164965, 0.010721655, -0.015438623, 0.0030390853, 0.013087138, -0.01440285, -0.010161777, -0.014878745, -0.014542819, 0.020225575, -0.009818852, 0.02075746, 0.009084013, -0.03205299, 0.00031777425, -0.02757397, 0.0005065142, -0.029589528, -0.016306434, 0.0043180557, 0.018993845, -0.013661012, -0.011834411, -0.008223201, 0.02166726, 0.0055357893, -0.012674227, 0.019007843, 0.02203118, -0.0053643268, -0.023388885, -0.014094917, 0.01622245, 0.0044020372, -0.008076234, 0.0033260225, 0.016376417, -0.022675041, 0.002633174, -0.004653982, 0.01083363, -0.004283063, -0.0069004907, 0.015886525, 0.007243416, 0.010903615, 0.015788546, -0.0010007811, -0.028189834, 0.015438623, 0.009811854, -0.012184335, -0.00074314995, 0.007803293, 0.013234105, 0.004475521, -0.006011685, -0.017398195, -0.0022937483, -0.003049583, 0.00621814, 0.019833662, 0.010679664, -0.005742244, 0.0045455056, 0.0062846253, -0.012121349, -0.008202206, -0.008762083, 0.004741463, 0.01581654, 0.009622895, -0.01916181, -0.6843943, -0.042718656, -0.0011040085, -0.022045178, 0.035944138, 0.030737277, 0.021135377, -0.019623708, -0.0015142937, 0.0073763863, -0.0028921175, 0.016306434, -0.026090292, -0.0028501265, 0.007292405, -0.028749712, 0.02523648, -0.02394876, 0.010000813, 0.024326678, -0.013968945, 0.01811204, -0.011631456, -0.00859412, 0.0038701536, -0.019903647, 0.002258756, -0.005549786, -0.01627844, 0.0079292655, -0.017286219, 0.027224045, 0.012261318, 0.0015807792, 0.049045272, -0.0055392883, -0.019637704, 0.035552222, -0.0024477146, 0.043726437, -0.021429313, -0.005385322, -0.00080263696, -0.01065167, 0.009489925, 0.014598806, 0.006757022, -0.009986816, -0.015732558, -0.04050714, 0.0077333082, -0.017076265, -0.0079292655, 0.010084794, -0.0053573283, 0.0034519949, 0.02953354, 0.0057667387, 0.0018563439, -0.0030163403, 0.0002429781, 0.005710751, -0.036336053, -0.006952979, -0.0070264633, 0.0054483083, -0.00205755, 0.009230981, -0.0043915394, -0.034096543, 0.027364014, 0.016068485, -0.010259756, 0.007474365, 0.021149375, 0.017748117, 0.016754335, -0.0033575157, -0.02953354, -0.009174993, 0.005444809, -0.004416034, -0.00498291, -0.031297155, 0.012681226, 0.0008594995, -0.023934765, -0.017748117, -0.0056932545, -0.0041990816, 0.018643921, 0.034684412, -0.0141439065, -0.017160246, 0.0065155746, -0.004531509, -0.010343738, 0.009825851, 0.009993814, -0.042774644, -0.010420721, -0.00598719, 0.004863936, 0.008881058, 0.012653233, 0.013136127, -0.017426189, 0.0107356515, 0.028035868, -0.02820383, -0.0046644798, 0.011239542, -0.010609679, 0.011393508, 0.0025754366, -0.029785484, -0.011799419, 0.0037021902, 0.030513326, -0.031353142, 0.025796358, -0.0120443655, 0.021429313, -0.0014600556, -0.0028081357, 0.020421533, -0.008167214, -0.015004718, -0.017608149, -0.0024249696, 0.019399757, -0.004758959, 0.018601932, -0.0051123817, 0.026342237, -0.026454214, 4.3159503e-06, 0.01632043, 0.010980599, 0.0045595025, -0.031073203, 0.0042725652, 0.0036077108, 0.0040241196, -0.027070079, -0.013898959, -0.02039354, -0.0014075671, -0.010525698, 0.001028775, -0.01330409, 0.009167994, -0.013479052, 0.023556847, -0.0015265411, -0.022940982, -0.023962758, -0.024270691, -0.0104697095, -0.025208486, 0.0031860531, 0.021569282, 0.0009028025, -0.0086851, -0.0032210455, -0.006277627, -0.015718563, 0.031857032, -0.036280066, -0.03140913, 0.021597276, -0.029729497, 0.0023759804, 0.019959634, -0.019959634, 0.016880307, -0.023444872, 0.0034362483, 0.018671915, -0.009860843, -0.01718824, 0.01184141, -0.00461899, 0.00051045086, 0.026720155, 0.017720124, 0.025908332, 0.03140913, -0.019035837, 0.01563458, -0.014878745, 0.027727935, 0.012058362, 0.0109736, -0.00041881463, 0.012870185, -0.011764427, 0.0007860156, 0.015340645, 0.0116944425, 0.027252039, 0.022325117, 0.036839943, -0.006253132, 0.011337521, -0.03126916, -0.020869436, -0.022870997, 0.030289374, 0.015900522, 0.0064001, -0.002267504, -0.0014049427, -0.023514856, 0.0113445185, 0.014528822, 0.017762115, -0.008475146, -0.012982161, -0.00079257664, 0.012520261, 0.00021367201, 0.0014434343, -0.022954978, -0.0009999063, 0.022059174, -0.0057387445, 0.027965883, 0.010889618, -0.027881902, -0.0020243071, 0.00051045086, 0.010168776, 0.004129097, 0.03314475, 0.0042865626, 0.009510919, 4.8743244e-05, 0.026902115, 0.0017259974, 0.01179242, -0.0015422876, 0.02021158, -0.020183586, 0.03264086, 0.0057212487, 0.054000188, 0.017272223, -0.019511731, 0.015928516, -0.03076527, -0.017048271, -0.0315491, 0.021275347, 0.013171119, 0.0044020372, -0.0005480676, -0.0035079827, -0.019651702, 0.01974968, 0.009748868, 0.030569313, 0.012590246, 0.006144656, -0.011358515, -0.012884182, 0.0065400694, 0.004625988, 0.011330522, -0.023514856, -0.0012763458, 0.0046609803, 0.00048070736, -0.011778424, 0.043082576, 0.011820414, 0.0065925578, 0.0065855593, 0.0060956664, 0.013332084, -0.006498079, -0.051956635, 0.023108946, 0.024438655, -0.008314181, -0.0047099697, -0.010462712, 0.012695223, -0.016250445, -0.0075233546, 0.007579342, 0.018391976, -0.006708033, 0.019203799, -0.015746556, -0.0043005594, 0.026412223, -0.0044125346, 0.017930077, -0.01906383, 0.0018126036, 0.022521073, 0.0067045335, -0.034768395, 0.030429345, -0.011470491, -0.012051364, -0.0201136, -0.012828194, -0.029617522, -0.008643109, -0.008559128, 0.0028151341, 0.008286187, 0.014157903, 0.009713875, -0.0038106665, -0.02665017, 0.025320461, 0.0023287407, -0.012548255, -0.023164934, -0.0063896026, -0.0021345331, 0.060634736, 0.0006806011, 0.008797076, 0.0017662387, -0.008209204, -0.0033452683, -0.018783892, -0.010161777, 0.009307964, -0.0049759117, -0.011176555, 0.012373294, 0.0032070484, -0.02455063, 0.019959634, 0.02793789, 0.015354642, -0.042214766, 0.0075373515, -0.012912176, 0.0070789517, 0.0023689817, 0.01110657, 0.011757428, 0.015564595, -0.021191364, 0.0056722593, 0.023570845, -0.011071579, -0.029869467, 0.024018746, 0.008601119, -0.0034257506, 0.015438623, -0.0020103103, -0.0061796485, 0.0072294185, 0.013640016, 0.0048989286, -0.024270691, 0.028497767, 0.021541288, 0.0001708064, -0.013765989, 0.014416846, -0.019357765, 0.018349987, 0.016908301, -0.01513069, -0.035860155, 0.013087138, 0.011449495, -0.023528853, 0.0027066579, -0.00617265, 0.050640922, 0.006442091, -0.003849158, 0.019497735, -0.029925454, -0.023654826, -0.017482176, -0.004493017, -0.00013023714, -0.008048239, -0.025222482, 0.0027119068, 0.010070797, 0.0022290125, 0.0015711563, 0.012366295, -0.006295123, -0.034600433, -0.02029556, 0.0062006437, 0.0042760647, 0.019189803, -0.012898179, -0.024886556, 0.028427782, 0.0005205111, -0.009349955, -0.0074603683, -0.0057702377, -0.018993845, 0.0038316618, -0.00562327, -0.016166463, 0.0016472647, 0.018349987, 0.017062267, 0.00033702003, 0.04143094, -0.008426157, -0.010756647, -0.016404413, 0.02793789, 0.023780799, -0.014241884, 0.008895054, 0.012814197, -0.04173887, -0.01682432, -0.012282314, 0.01494873, -0.0150887, 0.0233189, 0.0071174433, 0.0077333082, -0.012793202, -0.0012212329, 0.0016070235, 0.013332084, -0.03818365, 0.017930077, -0.014990721, 0.00073177746, -0.018839879, -0.0077822977, 0.014213891, 0.0044685225, -0.03264086, 0.02660818, 0.017762115, -0.010021808, -0.008482144, 0.03104521, -0.0055707814, -0.010315743, 0.006501578, -0.0060466775, 0.005231356, 0.005696754, -0.014360859, -0.0031790547, -0.02757397, -0.0057702377, 0.012765208, 0.0009307964, -0.018349987, -0.013779986, 0.015368639, -0.007341394, -0.0014425594, -0.0067150313, -0.030485332, 0.0030163403, 0.013898959, -0.012534258, 0.035552222, -0.021275347, 0.025446434, -0.003035586, 0.006508576, -0.015018715, -0.026734153, -0.0011031337, 0.0062811263, 0.032836817, 0.0062706284, 0.025586404, 0.009566908, 0.0301774, 0.018517949, 0.0069879717, -0.02075746, 0.010917612, -0.0014329365, 0.001499422, 0.013325085, 0.028147843, 0.014360859, 0.026216265, -0.018853877, 0.0053118384, 0.02939357, -0.017888088, -0.01595651, -0.0037371826, -0.037735745, 0.00023619834, 0.008762083, 0.0101197865, 0.013101134, -0.0072854063, 0.0058682165, 0.03194101, 0.018321993, 0.004447527, 0.00015002968, 0.02336089, -0.012485269, -0.006386103, 0.014598806, 0.007971256, -0.025642391, 0.0012562252, -0.010441716, 0.013297091, 0.03090524, -0.012520261, 0.017622145, 0.0121283475, 0.017580155, -0.006834005, 0.009643891, -0.012324304, -0.017440185, -0.0075373515, -0.016628362, -0.00095441623, -0.016054489, -0.0046784766, -0.032724842, 0.0032385415, -0.014696785, -0.006729028, 0.020505514, -0.021653263, -0.023570845, 0.037371825, 0.016040491, 0.023150936, 0.015368639, 0.04563002, 0.019077826, 0.006886494, -0.021611273, -0.012499266, 0.00891605, -0.0029603525, 0.005175368, 0.02245109, -0.013807979, -0.024018746, 0.014031931, 0.025110507, -0.0187419, -0.035580218, 0.024284689, 0.011988378, 0.020155592, -0.01906383, -0.022647046, -0.008433156, 0.030513326, -0.0052698473, -0.009902834, -0.013178118, -0.012814197, -0.0027643954, -0.0043040584, -0.0047484613, 0.017762115, 0.012359297, 0.013647015, 0.0038911488, -0.0017321211, 0.01458481, -0.006634549, -8.1739934e-05, 0.025992315, -0.0043355515, 0.019301778, 0.006554066, -0.005665261, 0.0019123317, -0.007320399, -0.00040984785, 0.029197613, -0.04280264, -0.011764427, 0.005707252, -0.010623677, 0.012233324, -0.0119603835, -0.007894273, 0.0173702, -0.017216234, -0.008706096, 0.010091793, 0.013255101, -0.012492267, 0.0023567346, -0.013129128, -0.022395102, 0.013241104, 0.0009526666, -0.012765208, -0.024970539, -0.0056582624, 0.002948105, -0.011036586, -0.006561065, 0.0324449, -0.018811885, 0.000589621, 0.023234917, -0.017244227, 0.0072714095, -0.0029026151, 0.015158684, -9.005061e-05, 0.018909864, -0.0021870215, -0.0042725652, 0.030009435, -0.0066485456, 0.0102037685, -0.002281501, 0.004986409, 0.01801406, 0.0064700847, 0.00617265, 0.014598806, 0.0028973662, -0.0075233546, -0.00052182336, -0.0024564627, -0.009300966, 0.0066135535, -0.0041220984, 0.010861624, -0.015508608, 0.024270691, 0.00034839255, 0.02642622, 0.0056722593, -0.029841473, -0.016166463, 0.0057947324, 0.010903615, -0.007054457, -0.0187419, -0.019133816, 0.0067815166, -0.019945636, -0.010280752, -0.0016218952, -0.029141625, -0.010483707, 0.009895835, 0.021177368, -0.0051088827, -0.005707252, -0.01070066, -0.00356572, -0.0021362826, -0.022185147, 0.010889618, -0.010581685, 0.022059174, 0.018937858, -0.030429345, -0.020729465, -0.013381073, -0.033200737, -0.0006141157, -0.0038701536, 0.015214672, 0.003560471, 0.008951042, -0.0010112788, 0.032248948, 0.0094129415, -0.015340645, -0.016404413, 0.0011687444, -0.01595651, -0.0042585684, -0.009181991, -0.0042340737, -0.0133600775, -0.0069739744, 0.0048009497, 0.0048674354, -0.006861999, -0.0072714095, -0.0032402913, -0.0064525884, 0.009895835, 0.008398163, -0.0013708251, 0.022521073, 0.0029183617, -0.025838349, 0.0010838879, 0.0052278563, -0.02866573, -0.004874434, 0.016180461, 0.010553692, 0.00047895772, 0.01156847, -0.00044877685, 0.0009937827, -0.0061096638, -0.027601963, 0.03126916, -0.015046709, 0.0018073546, 0.014612803, 0.004395039, -0.0009824102, -0.014360859, -0.0021467805, -0.017958071, -0.026062299, 0.003511482, -0.017258225, 0.023220921, -0.0005187615, 0.009755866, -0.006053676, -0.014248883, -0.0038841504, 0.010672665, -0.025572406, 0.026510201, -0.017412191, -0.0114354985, -0.0036741963, -0.022437092, -0.010707658, -0.02711207, -0.015830537, 0.00036938794, -0.017776111, -0.022675041, 0.012268317, -0.0256004, -0.02098141, 0.0069039897, 0.028469773, -0.016544381, 0.020127598, 0.22417496, -0.013633018, -0.02089743, 0.01083363, -0.007964258, 0.004580498, 0.03255688, 0.0037196863, -0.011897397, 0.011470491, 0.013066142, 0.015704565, -0.015256663, -0.0028816196, 0.010770644, -0.00016479207, -0.016670354, -0.019147811, -0.015480614, -0.005549786, 0.021905208, 0.010665667, -0.014472834, -0.016684351, 0.011400506, -0.01211435, -0.008895054, -0.006298622, -0.006323117, 0.011057582, -0.017678132, 0.013765989, 0.003310276, 0.0102947485, -0.01431187, -0.018224014, -0.006344112, 0.018671915, 0.016866311, 0.012037367, -0.0028133846, -0.0015265411, 0.0008087606, -0.013346081, -0.008559128, 0.020225575, -0.015144687, -0.021275347, -0.013388071, 0.022143157, -0.023626832, 0.002619177, 0.013633018, 0.017762115, -0.0059451996, 0.006323117, -0.0020540508, 0.024284689, 0.011337521, 0.021569282, -0.020785453, 0.015494611, 0.008923048, 0.013199113, -0.019119818, 0.007810292, -0.030933233, 0.024676602, 0.019035837, 0.008153217, 0.0010165276, -0.020687476, -0.00032805325, -0.02134533, -0.036727965, -0.030121412, 0.033676635, 0.015872529, 0.009468929, 0.006802512, -0.009063018, -0.008272191, 0.00086431095, -0.0061236606, -0.009105008, -0.026776142, 0.016082482, -0.005143875, -0.018280001, 0.003364514, -0.00078645296, -0.009790858, -0.0016673853, -0.012926172, 0.016474396, -0.0008647484, 0.026678165, 0.030009435, 0.0023654825, 0.012653233, -0.01682432, 0.013730996, 0.009314963, 0.015298653, -0.0054133157, 0.020351548, -0.0041220984, -0.0014976724, 0.004874434, -0.011589465, -0.040619116, -0.046441842, 0.008874059, -0.0054133157, 0.0008560003, -0.011127566, -0.014892742, -0.026342237, 0.013479052, -0.026454214, -0.0040241196, -0.008958041, -0.007474365, 0.025320461, -0.01581654, -0.029589528, -0.038295623, 0.005864717, -0.014346862, -0.011925392, 0.0018650921, -0.012324304, -0.01956772, 0.0041360953, -0.004440529, 0.0026209268, 0.01092461, -0.00051132566, -0.006596057, 0.007187428, 0.0053608273, 0.008153217, 0.0072574127, -0.012331302, -0.0017531165, -0.011365514, 0.032808825, 0.016600369, -0.027671948, -0.006522573, -0.011813416, 0.01088262, 0.0037686757, 0.0017793608, 0.031745058, -0.0006123661, -0.023570845, 0.0049444186, 0.006130659, 0.032220952, -0.049773112, 0.018825883, -0.010546693, -0.00076327054, -0.04232674, -0.011806417, -0.18487157, 0.00092729717, 0.026132284, -0.03689593, 0.016698347, 0.01974968, -0.0064210957, 0.02065948, -0.0067220298, 0.0033540165, 0.018629925, 0.016236449, -0.0019053333, -0.0075863404, 0.011757428, 0.012849189, -0.012653233, 0.02888968, 0.0033855094, 0.007803293, 0.0023759804, -0.014157903, -0.0041430937, -0.0051823664, 0.008650108, 0.0066135535, -0.009112007, 0.007488362, -0.0025229482, -0.029841473, -0.0007868904, -0.030849252, 0.020827444, -0.0016385166, 0.011666448, -0.0057352455, -0.0027416502, -0.023192927, -0.02981348, 0.01613847, 0.019315775, 0.027350018, 0.0028973662, -0.0025859345, -0.0051473742, 0.020813446, 0.005444809, -0.013248102, 0.014794764, -0.023570845, 0.008405161, -0.025712376, -0.0043040584, -0.0007265286, 0.026916113, 0.009846847, -0.004762458, -0.012786203, 0.015424626, -0.000848127, -0.01440285, -0.0053013405, 0.024158716, -0.008286187, -0.012408286, -0.0015344144, -0.0071349395, 0.024956541, -0.024788577, 0.020967415, 0.0020837942, -0.0042270753, -0.0029201112, -0.021177368, -0.0014810511, 0.000905427, -0.015508608, 0.018098041, -0.020085607, -0.008419159, -0.010434718, 0.023248915, -0.010315743, -0.00909801, -0.003579717, 0.003277033, 0.015522605, 0.004118599, -0.016586373, -0.01892386, 0.018839879, -0.020085607, -0.021513294, -0.0075513483, 0.0011573718, 0.028749712, 0.0005353829, -0.004580498, 0.007113944, -0.01974968, -0.00598719, 0.0033662636, -0.001992814, -0.0020103103, 0.005609273, 0.0053468305, -0.0026261755, 0.008531134, 0.023192927, -0.025964322, -0.0008800575, -0.000987659, -0.0023847283, 0.018349987, -0.0071384385, 0.029785484, -0.018517949, -0.025530417, 0.008314181, -0.012828194, 0.031073203, 0.0015746555, -0.0019455744, 0.023808792, -0.0018073546, -0.008783079, -0.07048858, -0.04182285, 0.0099448245, 0.033256724, -0.0062251384, 0.018363982, -0.013968945, 0.026930109, -0.035272285, 0.0010401475, 0.0044370294, -0.041011028, -0.022647046, -0.009049021, 0.026846128, -0.0049234233, -0.022773018, -0.013045146, -0.015648577, 0.012779205, 0.00923798, 0.0047379634, 0.027126066, -0.019217797, 0.007985253, 0.0018318493, -0.03821164, 0.01892386, 0.02144331, 0.017482176, 0.0025124503, -0.016558379, 0.007852282, -0.024676602, -0.0020138095, -0.015060706, -0.017426189, -0.02075746, 0.0029358577, -0.014101915, 0.007099947, -0.014031931, 0.022283126, 0.0052698473, -0.007012466, -0.0076423283, -0.006456088, 0.016936295, 0.005878714, -0.03241691, -0.037707753, -0.030149406, -0.011687444, -0.004608492, 0.009713875, 0.0012492267, 0.03835161, 0.0032385415, 0.00085293845, 0.009545912, 0.005248852, 0.011225545, -0.01001481, 0.009531915, 0.018042054, 0.008979036, -0.03068129, -0.008055238, 0.010518699, 0.0013734496, 0.0030775769, 0.022787016, -0.0018248508, 0.029253602, -0.01993164, -0.019875653, -0.017160246, -0.021541288, 0.008181211, -0.007621333, -0.036168087, -0.024172712, 0.0037091887, -0.019945636, 0.014598806, 0.0042305747, -0.018657919, -0.0067500235, 0.008426157, -0.02061749, 0.0043810415, 0.010693661, 0.006634549, -0.023486862, -0.025544412, -0.012422283, -0.015340645, -0.0047064708, 0.00987484, 0.0205755, -0.02021158, -0.009321961, -0.07569544, 0.012107352, 0.008398163, 0.011512482, 0.0030233387, -0.012674227, 0.019259788, -0.034600433, 0.0037371826, 0.0075233546, -0.031745058, -0.012947168, -0.003528978, 0.01563458, -0.011463492, -0.0022727528, 0.030793265, 0.0040941043, 0.01545262, -0.0036776955, 0.01088262, 0.005931203, 0.004087106, -0.012051364, 0.0034502454, 0.0009587903, -0.009475927, 0.009566908, -0.01682432, 0.015340645, -0.00058043556, -0.027140064, -0.025586404, 0.025516419, -0.025278471, -0.016012497, 0.011365514, 0.009377949, 0.014031931, 0.0033680133, -0.019833662, -0.02715406, 0.019665698, -0.02176524, -0.018601932, 0.005609273, -5.3636704e-05, -0.0069739744, 0.02463461, 0.0049234233, 0.005892711, 0.028861687, -0.025166495, -0.029729497, -0.030933233, -0.018028056, 0.0246906, 0.009126004, -0.005374824, 0.012268317, 0.022381105, 0.026762147, 0.011400506, 0.00832118, 0.009559909, 0.0027678946, -0.001065517, 0.012247321, 0.0121353455, -0.014682788, -0.02729403, -0.009797857, 0.0010383979, -0.0005843722, 0.013388071, 0.01079164, 0.008307183, 0.0015020465, -0.02765795, 0.015844535, 0.008489143, 0.0016997532, -0.012030369, 0.015424626, 0.028777706, 0.017216234, -0.0044230325, 0.007831287, 0.007922268, -0.011848409, -0.011827413, -0.0011442497, 0.008118224, 0.0037861718, 0.0043880404, 0.017258225, -0.008797076, 0.0012588496, 0.021611273, 0.0081042275, 0.007887275, 0.00076064613, 0.009804855, -0.013311088, -0.023752805, -0.0040451153, -0.014654795, -0.00955291, 0.0018825883, -0.006071172, 0.03003743, 0.022255132, 0.0074043805, 0.018895866, -0.008573125, 0.034572437, -0.0019823164, -0.005875215, -0.031241167, -0.0026594184, 0.02642622, 0.007845284, 0.012401287, -0.016894305, 0.016754335, 0.02116337, 0.013248102, -0.019819664, 0.00044330928, -0.0068515013, 0.007943262, -0.011946387, -0.015004718, -0.00028803074, -0.021961197, -0.012807199, -0.010581685, -0.0042095794, -0.043278534, 0.082525946, 0.024802575, 0.0019543224, -0.0033995064, -0.0061936453, -0.008958041, -0.010679664, 0.016698347, -0.032248948, -0.015060706, -0.009881838, -0.015256663, -0.012394289, -0.00066223013, 0.0066730403, -0.0080132475, -0.014360859, 0.020043615, 0.010154779, -0.016180461, 0.019637704, 0.01700628, 0.015942512, 0.010574687, -0.033340707, -0.013598026, 0.006816509, -0.0061341585, 0.00909801, -0.031017216, 0.0100288065, -0.0056302682, -0.034096543, -0.018853877, 0.00621814, 0.008839066, 0.0021292842, -0.0036811947, -0.0024564627, 0.026440216, -0.0109736, 0.028973663, -0.014269879, -0.037035897, 0.0005594401, 0.011316525, -0.023108946, -0.016194457, 0.0017207486 ]') as cosine_distance
FROM public.vector_store
ORDER BY cosine_distance
LIMIT 3
```

### Part 2:

#### Testing

##### Unit Test with mock

```java
@Test
    void streamingPromptChat() {
        given(this.chatModel.stream(this.promptCaptor.capture()))
                .willReturn(Flux.generate(
                        () -> new ChatResponse(List.of(new Generation(new AssistantMessage("Hello Carlos!")))), (state, sink) -> {
                            sink.next(state);
                            sink.complete();
                            return state;
                        }));

        var chatClient = ChatClient.builder(this.chatModel).build();
        // Simulate a chat response from Mock
        Flux<ChatResponse> chatResponseFlux = chatClient.prompt().user("My name is Carlo").stream().chatResponse();
        // Assert that the response content matches the expected output
        chatResponseFlux
                .doOnNext(chatResponse -> {
                    String content = chatResponse.getResult().getOutput().getText();
                    // Verify the prompt was captured
                    assertThat(content).isEqualTo("Hello Carlos!");
                })
                .blockLast(); // Block until the Flux completes to ensure all messages are processed
    }

    @Test
    void responseEntityTest() {
        // With ChatResponseMetadata
        ChatResponseMetadata chatResponseMetadata = ChatResponseMetadata.builder().keyValue("key1", "value1").build();

        var ChatResponse = new ChatResponse(List.of(new Generation(new AssistantMessage("""
				{"name":"Carlos", "age":35}
				"""))), chatResponseMetadata);

        given(this.chatModel.call(this.promptCaptor.capture()))
                .willReturn(ChatResponse);

        var chatClient = ChatClient.builder(this.chatModel).build();

        // Simulate a chat response from Mock
        Person person = chatClient.prompt()
                .user("My name is Carlos")
                .call()
                .entity(Person.class);

        assertThat(person).isNotNull();
        assertThat(person.name()).isEqualTo("Carlos");
        assertThat(person.age()).isEqualTo(35);
    }

    record Person(String name, int age){}
```

##### Integration Test with TestContainer

Uncomment
- `pom.xml`
- `TestcontainersConfiguration.java`
- `PGVectorStoreIT.java`

#### Moderation

```java
    @GetMapping("/moderation")
    public ModerationResponse moderation(@RequestParam(defaultValue = "I want to kill them..") String message) {
        ModerationPrompt prompt = new ModerationPrompt(message);
        return moderationModel.call(prompt);
    }
```

#### Multimodality - Image Generation

```java
    @GetMapping("/text-to-image")
    public Image generation(@RequestParam(defaultValue = "A cute cat") String prompt) {
        ImageOptions options = OpenAiImageOptions.builder()
                .model("dall-e-3")
                .width(1024)
                .height(1024)
                .quality("hd")
                .style("natural")
                .build();
        ImagePrompt imagePrompt = new ImagePrompt(prompt, options);

        ImageResponse imageResponse = imageModel.call(imagePrompt);
        return imageResponse.getResult().getOutput();
    }
```

